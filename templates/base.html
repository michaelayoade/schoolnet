<!doctype html>
<html lang="en"
      x-data="{ darkMode: localStorage.getItem('darkMode') === 'true' }"
      x-init="$watch('darkMode', val => localStorage.setItem('darkMode', val))"
      :class="{ 'dark': darkMode }">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="htmx-config" content='{"defaultSwapStyle":"innerHTML","globalViewTransitions":true}' />
    {% set csrf_value = csrf_token if csrf_token is defined else (request.state.csrf_token if request is defined and request.state is defined else "") %}
    <meta name="csrf-token" content="{{ csrf_value | default('', true) }}" />
    <title>{% block title %}{{ title | default("Starter Template") }}{% endblock %}</title>

    <!-- Custom Fonts: Outfit (display) + Plus Jakarta Sans (body) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    {% include "partials/_org_branding_head.html" %}

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'system-ui', 'sans-serif'],
                        display: ['Outfit', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        // Distinctive teal-cyan palette with warmth
                        primary: {
                            50: '#ecfeff',
                            100: '#cffafe',
                            200: '#a5f3fc',
                            300: '#67e8f9',
                            400: '#22d3ee',
                            500: '#06b6d4',
                            600: '#0891b2',
                            700: '#0e7490',
                            800: '#155e75',
                            900: '#164e63',
                            950: '#083344',
                        },
                        // Warm accent for contrast
                        accent: {
                            50: '#fff7ed',
                            100: '#ffedd5',
                            200: '#fed7aa',
                            300: '#fdba74',
                            400: '#fb923c',
                            500: '#f97316',
                            600: '#ea580c',
                            700: '#c2410c',
                            800: '#9a3412',
                            900: '#7c2d12',
                            950: '#431407',
                        }
                    }
                }
            }
        }
    </script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@2.0.0"></script>
    <script src="https://unpkg.com/htmx-ext-loading-states@2.0.0/loading-states.js"></script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            if (window.Alpine) {
                return;
            }
            const menus = new Map();
            document.querySelectorAll("[data-dropdown-trigger]").forEach((trigger) => {
                const menuId = trigger.getAttribute("data-dropdown-trigger");
                if (!menuId) {
                    return;
                }
                const menu = document.getElementById(menuId);
                if (!menu) {
                    return;
                }
                menu.removeAttribute("x-cloak");
                menu.style.display = "none";
                menus.set(menuId, { trigger, menu });
                trigger.addEventListener("click", (event) => {
                    event.stopPropagation();
                    const isOpen = menu.style.display !== "none";
                    menu.style.display = isOpen ? "none" : "block";
                });
            });
            document.addEventListener("click", (event) => {
                menus.forEach(({ trigger, menu }) => {
                    if (menu.style.display === "none") {
                        return;
                    }
                    if (menu.contains(event.target) || trigger.contains(event.target)) {
                        return;
                    }
                    menu.style.display = "none";
                });
            });
        });
    </script>

    <!-- Custom Styles -->
    <style>
        [x-cloak] { display: none !important; }
        .htmx-request .htmx-indicator { opacity: 1; }
        .htmx-indicator { opacity: 0; transition: opacity 200ms ease-in; }
        .htmx-request.htmx-indicator { opacity: 1; }

        /* Smooth transitions */
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Staggered card animations */
        .stagger-in {
            opacity: 0;
            transform: translateY(12px);
            animation: staggerFadeIn 0.5s ease-out forwards;
        }
        .stagger-in:nth-child(1) { animation-delay: 0ms; }
        .stagger-in:nth-child(2) { animation-delay: 75ms; }
        .stagger-in:nth-child(3) { animation-delay: 150ms; }
        .stagger-in:nth-child(4) { animation-delay: 225ms; }
        .stagger-in:nth-child(5) { animation-delay: 300ms; }
        .stagger-in:nth-child(6) { animation-delay: 375ms; }
        @keyframes staggerFadeIn {
            to { opacity: 1; transform: translateY(0); }
        }

        /* Background noise texture */
        .bg-noise {
            position: relative;
        }
        .bg-noise::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.025;
            pointer-events: none;
            z-index: 0;
        }
        .dark .bg-noise::before {
            opacity: 0.04;
        }

        /* Subtle gradient mesh for main areas */
        .bg-mesh {
            background-image:
                radial-gradient(at 0% 0%, rgba(6, 182, 212, 0.08) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(249, 115, 22, 0.06) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(6, 182, 212, 0.05) 0px, transparent 50%);
        }
        .dark .bg-mesh {
            background-image:
                radial-gradient(at 0% 0%, rgba(6, 182, 212, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(249, 115, 22, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(6, 182, 212, 0.08) 0px, transparent 50%);
        }

        /* Enhanced button hover states */
        .btn-hover {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-hover:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px -2px rgba(6, 182, 212, 0.25);
        }
        .btn-hover:active:not(:disabled) {
            transform: translateY(0);
        }

        /* Card hover lift effect */
        .card-hover {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.12);
        }
        .dark .card-hover:hover {
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.4);
        }

        /* Animated number counter */
        .counter-animate {
            display: inline-block;
            animation: counterPop 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes counterPop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Icon hover spin */
        .icon-hover-spin {
            transition: transform 0.3s ease;
        }
        .group:hover .icon-hover-spin {
            transform: rotate(12deg) scale(1.1);
        }

        @media (prefers-reduced-motion: reduce) {
            .fade-in,
            .stagger-in,
            .counter-animate {
                animation: none !important;
            }
            .btn-hover,
            .card-hover,
            .icon-hover-spin,
            .htmx-indicator {
                transition: none !important;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Display font for headings */
        h1, h2, h3, .font-display { font-family: 'Outfit', system-ui, sans-serif; }
    </style>
    {% block head %}{% endblock %}
</head>
<body class="min-h-screen bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 antialiased"
      hx-ext="loading-states">
    {% include "partials/_brand_context.html" %}

    {% block body %}
    <div class="relative">
        <header class="sticky top-0 z-40 border-b border-slate-200/70 bg-white/80 backdrop-blur dark:border-slate-800/70 dark:bg-slate-900/80">
            <div class="mx-auto flex max-w-5xl flex-col gap-4 px-6 py-6 md:flex-row md:items-center md:justify-between">
                <a href="/" class="flex items-center gap-3">
                    {% if brand_logo_url %}
                        <img src="{{ brand_logo_url }}" alt="{{ brand_name }} logo" class="h-11 w-11 rounded-xl object-cover shadow-lg shadow-primary-500/20" />
                    {% else %}
                        <div class="flex h-11 w-11 items-center justify-center rounded-xl bg-gradient-to-br from-primary-500 via-primary-600 to-accent-500 text-sm font-semibold uppercase text-white shadow-lg shadow-primary-500/30">
                            {{ brand_mark }}
                        </div>
                    {% endif %}
                    <div>
                        <p class="text-xs font-semibold uppercase tracking-[0.24em] text-primary-600 dark:text-primary-400">
                            {{ brand_tagline }}
                        </p>
                        <p class="mt-1 text-lg font-semibold text-slate-900 dark:text-white font-display">
                            {{ brand_name }}
                        </p>
                    </div>
                </a>
                <div class="flex items-center gap-3 text-sm">
                    <a href="#branding" class="rounded-full border border-slate-200 px-4 py-2 font-medium text-slate-600 transition hover:border-primary-300 hover:text-primary-600 dark:border-slate-700 dark:text-slate-300 dark:hover:border-primary-500/60 dark:hover:text-primary-300">
                        Branding
                    </a>
                    <a href="#avatar" class="rounded-full bg-gradient-to-r from-primary-600 to-primary-500 px-4 py-2 font-medium text-white shadow-lg shadow-primary-500/25 btn-hover">
                        Avatar
                    </a>
                </div>
            </div>
        </header>
        <main>
            {% block content %}{% endblock %}
        </main>
    </div>
    {% endblock %}

    <!-- CSRF Auto-Injection: injects token into all POST forms, HTMX requests, and fetch() calls -->
    <script>
        (function() {
            const meta = document.querySelector('meta[name="csrf-token"]');
            const token = meta ? meta.getAttribute('content') : '';
            if (!token) return;

            function ensureToken(form) {
                const method = (form.getAttribute('method') || 'get').toLowerCase();
                if (method !== 'post') return;
                if (form.querySelector('input[name="csrf_token"]')) return;
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'csrf_token';
                input.value = token;
                form.appendChild(input);
            }

            function scanForms(root) {
                const scope = root || document;
                scope.querySelectorAll('form').forEach(ensureToken);
            }

            scanForms();

            // Inject CSRF header into all HTMX requests
            document.body.addEventListener('htmx:configRequest', function(event) {
                event.detail.headers['X-CSRF-Token'] = token;
            });

            // Re-scan forms after HTMX swaps in new content
            document.body.addEventListener('htmx:afterSwap', function(event) {
                scanForms(event.target);
            });

            // Monkey-patch fetch() to include CSRF header
            const originalFetch = window.fetch;
            window.fetch = function(resource, options) {
                const opts = options || {};
                const headers = new Headers(opts.headers || {});
                if (!headers.has('X-CSRF-Token')) {
                    headers.set('X-CSRF-Token', token);
                }
                opts.headers = headers;
                return originalFetch(resource, opts);
            };
        })();
    </script>

    <!-- Toast Notification Container -->
    <div id="toast-container"
         x-data="toastStore()"
         x-on:show-toast.window="addToast($event.detail)"
         role="status"
         aria-live="polite"
         aria-atomic="true"
         class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 pointer-events-none">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-show="toast.visible"
                 x-transition:enter="transform ease-out duration-300"
                 x-transition:enter-start="translate-y-2 opacity-0"
                 x-transition:enter-end="translate-y-0 opacity-100"
                 x-transition:leave="transform ease-in duration-200"
                 x-transition:leave-start="translate-y-0 opacity-100"
                 x-transition:leave-end="translate-y-2 opacity-0"
                 :class="{
                     'bg-green-600': toast.type === 'success',
                     'bg-red-600': toast.type === 'error',
                     'bg-yellow-500': toast.type === 'warning',
                     'bg-blue-600': toast.type === 'info'
                 }"
                 class="px-4 py-3 rounded-lg shadow-lg text-white text-sm font-medium pointer-events-auto flex items-center gap-2 max-w-sm">
                <span x-text="toast.message"></span>
                <button x-on:click="removeToast(toast.id)" aria-label="Dismiss notification" class="ml-2 hover:opacity-75">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </template>
    </div>

    <!-- Global Scripts -->
    <script>
        // Toast notification store
        function toastStore() {
            return {
                toasts: [],
                addToast(detail) {
                    const id = Date.now();
                    this.toasts.push({
                        id,
                        message: detail.message,
                        type: detail.type || 'info',
                        visible: true
                    });
                    setTimeout(() => this.removeToast(id), detail.duration || 4000);
                },
                removeToast(id) {
                    const toast = this.toasts.find(t => t.id === id);
                    if (toast) {
                        toast.visible = false;
                        setTimeout(() => {
                            this.toasts = this.toasts.filter(t => t.id !== id);
                        }, 300);
                    }
                }
            }
        }

        // Global helper: window.showToast('message', 'success')
        window.showToast = function(message, type, duration) {
            window.dispatchEvent(new CustomEvent('show-toast', {
                detail: { message, type: type || 'info', duration: duration || 4000 }
            }));
        };

        // ═══════════════════════════════════════════════════════════════════
        // Query-Parameter Toast Consumer
        // Shows toast messages from URL params (?success=, ?error=, etc.)
        // then cleans the URL to prevent re-display on refresh.
        // ═══════════════════════════════════════════════════════════════════
        (function consumeQueryMessages() {
            const params = new URLSearchParams(window.location.search);
            const keys = ["error", "success", "warning", "info", "created", "updated", "deleted"];
            let changed = false;

            keys.forEach(function(key) {
                if (!params.has(key)) return;
                const value = params.get(key);
                if (value) {
                    const type =
                        key === "error" ? "error" :
                        key === "warning" ? "warning" :
                        key === "info" ? "info" :
                        "success";
                    window.dispatchEvent(new CustomEvent("show-toast", {
                        detail: { message: value, type: type }
                    }));
                }
                params.delete(key);
                changed = true;
            });

            if (changed) {
                const newQuery = params.toString();
                const newUrl = window.location.pathname + (newQuery ? "?" + newQuery : "") + window.location.hash;
                window.history.replaceState({}, "", newUrl);
            }
        })();

        // HTMX event listeners for toasts
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            const trigger = evt.detail.xhr.getResponseHeader('HX-Trigger');
            if (trigger) {
                try {
                    const data = JSON.parse(trigger);
                    if (data.showToast) {
                        window.dispatchEvent(new CustomEvent('show-toast', { detail: data.showToast }));
                    }
                } catch (e) {}
            }
        });

        // Dark mode system preference detection
        if (localStorage.getItem('darkMode') === null) {
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                localStorage.setItem('darkMode', 'true');
                document.documentElement.classList.add('dark');
            }
        }

        window.__authEnabled = {% if user is defined and user and user.is_authenticated %}true{% else %}false{% endif %};

        // ═══════════════════════════════════════════════════════════════════
        // Automatic Token Refresh Manager
        // Keeps users logged in by refreshing access tokens periodically
        // ═══════════════════════════════════════════════════════════════════
        (function() {
            var REFRESH_INTERVAL_MS = 10 * 60 * 1000;   // Every 10 minutes
            var MIN_REFRESH_INTERVAL_MS = 30000;          // Don't refresh more than once per 30s

            var refreshTimeoutId = null;
            var lastRefreshTime = 0;
            var refreshDisabled = false;
            var refreshInProgress = false;

            async function refreshToken() {
                if (!window.__authEnabled || refreshDisabled || refreshInProgress) return;
                var currentPath = window.location.pathname;
                if (currentPath === '/login' || currentPath === '/admin/login') return;
                var now = Date.now();
                if (now - lastRefreshTime < MIN_REFRESH_INTERVAL_MS) {
                    scheduleNextRefresh();
                    return;
                }

                refreshInProgress = true;
                try {
                    var response = await fetch('/auth/refresh', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({}),
                    });

                    if (response.ok) {
                        await response.json();
                        lastRefreshTime = Date.now();
                        console.debug('[Auth] Token refreshed successfully');
                    } else if (response.status === 401) {
                        console.debug('[Auth] Session expired, redirecting to login');
                        refreshDisabled = true;
                        var redirectTarget = window.location.pathname + window.location.search;
                        if (currentPath !== '/login' && currentPath !== '/') {
                            window.location.href = '/login?next=' + encodeURIComponent(redirectTarget);
                        }
                        return;
                    }
                } catch (e) {
                    console.debug('[Auth] Token refresh failed:', e.message);
                } finally {
                    refreshInProgress = false;
                }

                scheduleNextRefresh();
            }

            function scheduleNextRefresh() {
                if (!window.__authEnabled || refreshDisabled) return;
                if (refreshTimeoutId) clearTimeout(refreshTimeoutId);
                refreshTimeoutId = setTimeout(refreshToken, REFRESH_INTERVAL_MS);
            }

            function onUserActivity() {
                if (!window.__authEnabled || refreshDisabled) return;
                if (Date.now() - lastRefreshTime < MIN_REFRESH_INTERVAL_MS) return;
                scheduleNextRefresh();
            }

            ['click', 'keydown', 'scroll', 'touchstart'].forEach(function(event) {
                document.addEventListener(event, onUserActivity, { passive: true });
            });

            if (window.__authEnabled) scheduleNextRefresh();

            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'visible' && window.__authEnabled && !refreshDisabled) {
                    var elapsed = Date.now() - lastRefreshTime;
                    if (elapsed >= REFRESH_INTERVAL_MS) {
                        refreshToken();
                    } else {
                        scheduleNextRefresh();
                    }
                }
            });
        })();

        // ═══════════════════════════════════════════════════════════════════
        // Form Double-Submit Protection
        // Disables submit buttons after first click to prevent duplicates
        // ═══════════════════════════════════════════════════════════════════
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('submit', function(e) {
                var form = e.target;
                if (!form || form.tagName !== 'FORM') return;
                var method = (form.method || 'GET').toUpperCase();
                if (method !== 'POST') return;

                var btn = form.querySelector('button[type="submit"], input[type="submit"]');
                if (btn && !btn.disabled) {
                    btn.disabled = true;
                    btn.dataset.originalText = btn.textContent;
                    btn.textContent = 'Processing\u2026';
                    // Re-enable after 8s in case of error (no redirect)
                    setTimeout(function() {
                        btn.disabled = false;
                        if (btn.dataset.originalText) {
                            btn.textContent = btn.dataset.originalText;
                        }
                    }, 8000);
                }
            });
        });
    </script>

    {% block scripts %}{% endblock %}
    <script defer src="/static/js/typeahead.js"></script>
    <script defer src="/static/js/avatar.js"></script>
</body>
</html>
